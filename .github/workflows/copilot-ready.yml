name: Copilot Ready (Env + Hygiene + Build)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  hygiene:
    name: Hygiene (secrets, env misuse, domains, size)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute diff range
        id: diff
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            echo "range=origin/${{ github.base_ref }}..HEAD" >> "$GITHUB_OUTPUT"
          else
            echo "range=HEAD^..HEAD" >> "$GITHUB_OUTPUT"
          fi

      - name: Block files >80MB
        run: |
          set -e
          RANGE="${{ steps.diff.outputs.range }}"
          for f in $(git diff --name-only "$RANGE"); do
            [ -f "$f" ] || continue
            sz=$(wc -c <"$f")
            if [ "$sz" -gt 80000000 ]; then
              echo "❌ $f is >80MB"
              exit 1
            fi
          done
          echo "✅ No files >80MB"

      - name: Lightweight secret scan
        run: |
          set -e
          if git grep -nE '(PRIVATE_STOREFRONT_API_TOKEN|SESSION_SECRET|shpat_[0-9a-f]{8,})' -- . ; then
            echo "❌ Potential secret found"
            exit 1
          fi
          echo "✅ No obvious secrets in tracked text"

      - name: Forbid raw env in app/** (exclude helpers)
        run: |
          set -e
          if git grep -nE '(process\.env|import\.meta\.env|context\.env)' -- 'app/' \
            | grep -v 'app/utils/env.server' \
            | grep -v 'app/utils/env.public' ; then
            echo "❌ Raw env usage in app/**"
            exit 1
          fi
          echo "✅ No raw env usage in app/**"

      - name: Hard-coded domain scan in app/**
        run: |
          set -e
          if git grep -nE '(ynx40dr-bu\.myshopify\.com|nuwudorder\.com|o2\.myshopify\.dev)' -- app/ ; then
            echo "❌ Hard-coded domain(s) in app/**"
            exit 1
          fi
          echo "✅ No hard-coded domains in app/**"

  build:
    name: Build & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci

      # Seed benign PUBLIC env for PR builds so build can run without secrets
      - name: Seed public env + CI context for PR
        if: github.event_name == 'pull_request'
        run: |
          {
            echo "PUBLIC_STORE_DOMAIN=example.myshopify.com"
            echo "PUBLIC_STOREFRONT_API_TOKEN=dummy"
            echo "PUBLIC_STOREFRONT_ID=0000000000"
            echo "PUBLIC_STOREFRONT_API_VERSION=2025-04"
            echo "PUBLIC_CUSTOMER_ACCOUNT_API_CLIENT_ID=dummy"
            echo "PUBLIC_CUSTOMER_ACCOUNT_API_URL=https://shopify.com/00000000000"
            echo "WM_CI_CONTEXT=pr"
          } >> "$GITHUB_ENV"

      - name: env:check (mode aware)
        run: npm run env:check

      - run: npm run lint --if-present
      - run: npm run build
