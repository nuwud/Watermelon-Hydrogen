name: Copilot Ready (Env + Hygiene + Build)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  hygiene:
    name: Hygiene (secrets, env misuse, domains, size)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute diff range
        id: diff
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            echo "range=origin/${{ github.base_ref }}..HEAD" >> "$GITHUB_OUTPUT"
          else
            echo "range=HEAD^..HEAD" >> "$GITHUB_OUTPUT"
          fi

      - name: Block files >80MB
        run: |
          set -e
          RANGE="${{ steps.diff.outputs.range }}"
          for f in $(git diff --name-only "$RANGE"); do
            [ -f "$f" ] || continue
            sz=$(wc -c <"$f")
            if [ "$sz" -gt 80000000 ]; then
              echo "❌ $f is >80MB"
              exit 1
            fi
          done
          echo "✅ No files >80MB"

      - name: Lightweight secret scan
        run: |
          set -e
          # Only scan for actual secret VALUES, not variable names
          # - shpat_* = Shopify private app tokens
          # - Actual token patterns (hex strings after = sign)
          if git grep -nE 'shpat_[0-9a-fA-F]{32,}' -- . ':!*.md' ':!*.yml' ':!*.yaml' ; then
            echo "❌ Potential Shopify token found"
            exit 1
          fi
          # Check for actual secret values (not empty assignments)
          if git grep -nE '(PRIVATE_STOREFRONT_API_TOKEN|SESSION_SECRET)=[a-zA-Z0-9]{20,}' -- . ':!*.md' ':!*.sample' ; then
            echo "❌ Potential secret value found"
            exit 1
          fi
          echo "✅ No obvious secrets in tracked text"

      - name: Forbid raw env in app/** (exclude helpers)
        run: |
          set -e
          # Check for forbidden env patterns, excluding:
          # - env.server.ts, env.public.ts (wrappers)
          # - buildInfo.server.ts (server utility)
          # - NODE_ENV checks (standard pattern)
          # - context.env passed to getEnvServer() (valid pattern)
          if git grep -nE '(process\.env|import\.meta\.env|context\.env)' -- 'app/' \
            | grep -v 'app/utils/env.server' \
            | grep -v 'app/utils/env.public' \
            | grep -v 'app/utils/buildInfo.server' \
            | grep -v 'NODE_ENV' \
            | grep -v 'getEnvServer(context.env)' \
            | grep -v 'context.env as Record' ; then
            echo "❌ Raw env usage in app/**"
            exit 1
          fi
          echo "✅ No raw env usage in app/**"

      - name: Hard-coded domain scan in app/**
        run: |
          set -e
          # Scan for hard-coded domains, excluding env helper files (where examples may appear)
          if git grep -nE '(ynx40dr-bu\.myshopify\.com|nuwudorder\.com|o2\.myshopify\.dev)' -- app/ \
            | grep -v 'app/utils/env.server' \
            | grep -v 'app/utils/env.public' ; then
            echo "❌ Hard-coded domain(s) in app/**"
            exit 1
          fi
          echo "✅ No hard-coded domains in app/**"

  build:
    name: Build & Lint
    runs-on: ubuntu-latest
    env:
      # Increase Node memory for builds with large bundles (8GB for safety)
      NODE_OPTIONS: '--max-old-space-size=8192'
      # Set CI context so env:check runs in public-only mode
      WM_CI_CONTEXT: 'pr'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci

      # Create .env file with dummy values for CI builds
      - name: Create .env for CI
        run: |
          cat > .env << 'EOF'
          PUBLIC_STORE_DOMAIN=example.myshopify.com
          PUBLIC_STOREFRONT_API_TOKEN=dummy-token-for-ci-build
          PUBLIC_STOREFRONT_ID=0000000000
          PUBLIC_STOREFRONT_API_VERSION=2025-04
          PUBLIC_CUSTOMER_ACCOUNT_API_CLIENT_ID=dummy-client-id
          PUBLIC_CUSTOMER_ACCOUNT_API_URL=https://shopify.com/00000000000
          WM_CI_CONTEXT=pr
          EOF

      - name: env:check (mode aware)
        run: npm run env:check

      - run: npm run lint --if-present
      - run: npm run build
